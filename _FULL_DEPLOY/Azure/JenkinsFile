pipeline {
    agent {
        label 'java' // Ensures the pipeline runs on agents with the 'java' label
    }
    environment {
        // Define environment variables for email settings
        RECIPIENTS = 'lloyd.malfliet@gmail.com' // Change to the appropriate recipient email addresses
        SENDER_EMAIL = 'jenkins@lodywood.be' // The sender's email address
    }
    stage('Checkout') {
        steps {
            // Use SSH-based authentication with Jenkins credentials
            checkout([
                $class: 'GitSCM',
                branches: [[name: 'main']], // Specify the branch to checkout
                userRemoteConfigs: [[
                    url: 'git@github.com:ReC82/Workshop_CICD.git', // GitHub repository with SSH URL
                    credentialsId: 'github-ssh-key' // Reference the Jenkins SSH key credential
                ]],
                extensions: [[$class: 'RelativeTargetDirectory', relativeTargetDir: '_FULL_DEPLOY/Azure']] // Checkout to subdirectory
            ])
        }
    }

    stage('SonarQube Analysis') {
        steps {
            withSonarQubeEnv('mysonar') { // Ensure this matches the configured SonarQube environment in Jenkins
                dir('_FULL_DEPLOY/Azure') {
                    sh 'sonar-scanner' // Run the SonarQube scan
                }
            }
        }
    }
    post {
        success {
            // Send an email if the pipeline succeeds
            emailext(
                subject: "Jenkins Pipeline Success: ${currentBuild.fullDisplayName}",
                body: """
                Pipeline execution was successful.

                - Build Number: ${currentBuild.number}
                - Build URL: ${env.BUILD_URL}

                Check the details for more information.
                """,
                to: RECIPIENTS,
                replyTo: SENDER_EMAIL
            )
        }
        failure {
            // Send an email if the pipeline fails
            emailext(
                subject: "Jenkins Pipeline Failure: ${currentBuild.fullDisplayName}",
                body: """
                Pipeline execution failed.

                - Build Number: ${currentBuild.number}
                - Build URL: ${env.BUILD_URL}

                Please check the logs for details.
                """,
                to: RECIPIENTS,
                replyTo: SENDER_EMAIL
            )
        }
        always {
            echo 'Pipeline completed' // A simple post-pipeline message
        }
    }
}
